---
---

<div id="lightbox" class="lightbox" aria-hidden="true">
  <button class="lightbox__close" aria-label="Fermer la lightbox">
    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
  <div class="lightbox__loader" id="lightbox-loader">
    <div class="lightbox__spinner"></div>
  </div>
  <div class="lightbox__content">
    <img id="lightbox-image" src="" alt="" class="lightbox__image" />
  </div>
</div>

<style>
  .lightbox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox--active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox__close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
    z-index: 10000;

    &:hover {
      transform: scale(1.1);
    }

    &:focus {
      outline: 2px solid white;
      outline-offset: 4px;
    }
  }

  .lightbox__content {
    max-width: 90%;
    max-height: 90%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox__loader {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .lightbox__loader--visible {
    opacity: 1;
    visibility: visible;
  }

  .lightbox__spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .lightbox__image {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .lightbox__image--loaded {
    opacity: 1;
  }

  .lightbox__content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 0.5rem;
  }

  @media (max-width: 768px) {
    .lightbox__close {
      top: 1rem;
      right: 1rem;
    }
  }
</style>

<script>
  const lightbox = document.getElementById('lightbox') as HTMLElement;
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const lightboxLoader = document.getElementById('lightbox-loader') as HTMLElement;
  const closeButton = document.querySelector('.lightbox__close') as HTMLButtonElement;
  const galleryItems = document.querySelectorAll('.media-gallery__item') as NodeListOf<HTMLButtonElement>;

  function openLightbox(imageSrc: string, imageAlt: string) {
    // Ouvrir la lightbox immédiatement
    lightbox.classList.add('lightbox--active');
    lightbox.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';

    // Cacher l'image précédente et afficher le loader
    lightboxImage.classList.remove('lightbox__image--loaded');
    lightboxLoader.classList.add('lightbox__loader--visible');

    // Précharger la nouvelle image
    const tempImage = new Image();
    tempImage.onload = () => {
      // Une fois l'image chargée, l'afficher
      lightboxImage.src = imageSrc;
      lightboxImage.alt = imageAlt;

      // Cacher le loader et afficher l'image
      lightboxLoader.classList.remove('lightbox__loader--visible');
      lightboxImage.classList.add('lightbox__image--loaded');
    };
    tempImage.onerror = () => {
      // En cas d'erreur, cacher le loader
      lightboxLoader.classList.remove('lightbox__loader--visible');
      console.error('Erreur lors du chargement de l\'image');
    };
    tempImage.src = imageSrc;
  }

  function closeLightbox() {
    lightbox.classList.remove('lightbox--active');
    lightbox.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';

    // Réinitialiser l'état de l'image et du loader
    lightboxImage.classList.remove('lightbox__image--loaded');
    lightboxLoader.classList.remove('lightbox__loader--visible');
    lightboxImage.src = '';
    lightboxImage.alt = '';
  }

  galleryItems.forEach((item) => {
    item.addEventListener('click', () => {
      const imageSrc = item.dataset.image!;
      const imageAlt = item.dataset.alt!;
      openLightbox(imageSrc, imageAlt);
    });
  });

  closeButton.addEventListener('click', closeLightbox);

  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) {
      closeLightbox();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && lightbox.classList.contains('lightbox--active')) {
      closeLightbox();
    }
  });
</script>