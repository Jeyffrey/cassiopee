---
import Layout from '../layouts/Layout.astro';
import { contentfulClient } from '../lib/contentful';
import type { Document } from '@contentful/rich-text-types';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';
import type { ContentfulAssetField } from '../types/contentful';
import WaveSeparator from '../components/WaveSeparator.astro';

const base = import.meta.env.BASE_URL;

const entries = await contentfulClient.getEntries({
  content_type: 'accueil',
});

const accueil = entries.items[0];

// Bannière
const banniereImage = accueil?.fields?.banniereImage as ContentfulAssetField | undefined;
const banniereImageBaseUrl = banniereImage?.fields?.file?.url;
const banniereImageUrl = banniereImageBaseUrl + '?w=1400&q=100&fm=webp';
const banniereImageAlt = banniereImage?.fields?.title || 'Image de bannière';

const banniereTexte = accueil?.fields?.banniereTexte as Document;
const banniereTexteHtml = banniereTexte ? documentToHtmlString(banniereTexte) : '';

// Présentation
const presentation = accueil?.fields?.presentation as Document;
const presentationHtml = presentation ? documentToHtmlString(presentation) : '';

// Vidéos youtube
const videos = (accueil?.fields?.idVideoYoutube as string[]) || [];

// Photo
const photo = accueil?.fields?.photo as ContentfulAssetField | undefined;
const photoBaseUrl = photo?.fields?.file?.url;
const photoUrl = photoBaseUrl + '?w=1400&q=100&fm=webp';
const photoAlt = photo?.fields?.title || 'Image de bannière';
---

<Layout title="Chœur Cassiopée, Lyon - Chorale de jeunes">
  <div class="container">
    <div class="banner">
      <h1 class="banner__titre c-global-title" set:html={banniereTexteHtml} />
      {
        banniereImageUrl && (
          <img
            class="banner__image"
            srcset={`https:${banniereImageBaseUrl}?w=800&q=80&fm=webp 800w, https:${banniereImageBaseUrl}?w=1400&q=100&fm=webp 1400w`}
            sizes="(max-width: 980px) 800px, 1400px"
            src={`https:${banniereImageUrl}`}
            alt={banniereImageAlt}
          />
        )
      }
    </div>

    <WaveSeparator />

    <section class="presentation-section">
      <div class="presentation-section__content">
        <Fragment set:html={presentationHtml} />
      </div>
      <a href={`${base}/le-choeur`} class="presentation-section__link c-global-link"
        >Découvrir le chœur</a
      >
      <a href={`${base}/nous-rejoindre`} class="presentation-section__link c-global-link"
        >Nous rejoindre</a
      >
    </section>

    <WaveSeparator flip />

    {
      videos.length > 0 && (
        <section class="videos-section">
          <ul>
            {videos.map((videoId: string) => (
              <li>
                <iframe
                  src={`https://www.youtube.com/embed/${videoId}`}
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                />
              </li>
            ))}
          </ul>
          <a href={`${base}/medias`} class="videos-section__link c-global-link">
            Voir nos photos et vidéos
          </a>
        </section>
      )
    }

    {
      photoUrl && (
        <section class="photo-section">
          <img
            srcset={`https:${photoBaseUrl}?w=800&q=80&fm=webp 800w, https:${photoBaseUrl}?w=1400&q=100&fm=webp 1400w`}
            sizes="(max-width: 980px) 800px, 1000px"
            src={`https:${photoUrl}`}
            alt={photoAlt}
          />
        </section>
      )
    }
  </div>
</Layout>

<style>
  /* Banniere */
  .banner {
    display: grid;
    align-items: center;
    grid-template-columns: max-content auto;
    gap: 3rem;
    max-width: 1300px;
    min-height: 28rem;
    margin: 0 auto -10rem;
    padding: 0 2rem;
  }

  .banner__titre {
    margin-block: -4rem 0;
    white-space: pre-line;

    b:first-of-type {
      color: var(--c-orange);
    }
    b:nth-of-type(2) {
      color: var(--c-vert);
    }
    b:nth-of-type(3) {
      color: var(--c-taupe);
    }
    b:nth-of-type(4) {
      color: var(--c-bleu);
    }
  }

  .banner__image {
    max-width: 100%;
    clip-path: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="blob" clipPathUnits="objectBoundingBox"><path d="M 0.53,0.03 C 0.22,-0.02 -0.02,0.22 0.02,0.56 C 0.05,0.82 0.18,0.94 0.34,0.96 C 0.44,0.97 0.64,0.97 0.76,0.92 C 0.90,0.85 1.02,0.68 0.97,0.42 C 0.92,0.10 0.80,0.07 0.53,0.03 Z"/></clipPath></defs></svg>#blob');
  }

  @media (max-width: 980px) {
    .banner {
      display: block;
      margin-bottom: -100px;
      padding: 0 1rem;
      text-align: center;
    }

    .banner__titre {
      margin-top: 2rem;
    }

    .banner__image {
      width: 700px;
      max-width: 100%;
    }
  }

  /* PRESENTATION */
  .presentation-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 4rem 1rem 2rem;
    background-color: #fff;
  }

  .presentation-section__content {
    max-width: 800px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    text-align: center;
    line-height: 2;
    text-wrap: pretty;
    white-space: pre-line;
  }

  .presentation-section__link {
    margin-top: 2rem;
  }

  @media (max-width: 980px) {
    .presentation-section {
      padding: 1rem 2rem 0;
    }

    .presentation-section__content {
      font-size: 1.25rem;
      line-height: 1.7;
    }
  }

  /* VIDEOS */
  .videos-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 auto;
    padding: 4rem 2rem;

    ul {
      display: flex;
      gap: 2rem;
      width: min(1600px, 100%);
      list-style: none;
      margin: 0;
      padding: 0;
    }

    li {
      flex: 1;
      border-radius: 1.5rem;
      overflow: hidden;
    }

    iframe {
      display: block;
      height: 100%;
      width: 100%;
      border: none;
      aspect-ratio: 16 / 9;
    }
  }

  .videos-section__link {
    margin-top: 3rem;
  }

  @media (max-width: 980px) {
    .videos-section {
      padding-block: 2rem;
      margin-top: -1rem;

      ul {
        flex-direction: column;
      }
    }
  }

  /* PHOTO */
  .photo-section {
    padding: 2rem;

    img {
      display: block;
      width: min(100%, 1000px);
      margin: 0 auto;
      clip-path: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="blob" clipPathUnits="objectBoundingBox"><path d="M 0.55,0.02 C 0.30,-0.03 0.13,0.07 0.04,0.28 C -0.04,0.47 0.03,0.65 0.06,0.78 C 0.09,0.92 0.18,1.0 0.38,0.98 C 0.58,0.955 0.77,1.06 0.92,0.94 C 1.0,0.88 1.01,0.68 0.97,0.5 C 0.93,0.32 0.86,0.08 0.55,0.02 Z"/></clipPath></defs></svg>#blob');
    }
  }
</style>
