---
import Layout from '../layouts/Layout.astro';
import { contentfulClient } from '../lib/contentful';
import type { Document } from '@contentful/rich-text-types';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';

const entries = await contentfulClient.getEntries({
  content_type: 'concert',
});

const allConcerts = entries.items.map((entry) => entry.fields);

const now = new Date();
const upcomingConcerts = allConcerts
  .filter((concert) => new Date(concert.date as string) >= now)
  .sort((a, b) => new Date(a.date as string).getTime() - new Date(b.date as string).getTime());

const getDate = (dateString: string) => {
  const date = new Date(dateString);
  const frenchMonths = [
    'janvier',
    'février',
    'mars',
    'avril',
    'mai',
    'juin',
    'juillet',
    'août',
    'septembre',
    'octobre',
    'novembre',
    'décembre',
  ];

  const day = date.getDate();
  const month = frenchMonths[date.getMonth()];
  const year = date.getFullYear();

  return `${day} ${month} ${year}`;
};

const getTime = (dateString: string) => {
  const date = new Date(dateString);

  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');

  return `${hours}h${minutes}`;
};
---

<Layout title="Concerts du chœur Cassiopée, Lyon - Chorale de jeunes">
  <section class="concerts c-global-container">
    <h1 class="concerts__main-title c-global-title">Nos concerts</h1>

    <h2 class="concerts__sub-title">Concerts à venir</h2>
    {
      upcomingConcerts.length > 0 ? (
        <ol class="concerts__list">
          {upcomingConcerts.map((concert) => (
            <li>
              <div class="infos c-global-text-container">
                <div class="date">
                  <strong>Date</strong>
                  <span>{getDate(concert.date as string)}</span>
                </div>
                <div class="hour">
                  <strong>Heure</strong>
                  <span>{getTime(concert.date as string)}</span>
                </div>
                <div class="place c-global-text-container">
                  <strong>Lieu</strong>
                  <Fragment set:html={documentToHtmlString(concert.lieu as Document)} />
                </div>
              </div>
              <div class="content">
                <h2 class="title c-global-title">{concert.titre}</h2>
                {concert.texte && (
                  <div class="text c-global-text-container">
                    <Fragment set:html={documentToHtmlString(concert.texte as Document)} />
                  </div>
                )}
              </div>
            </li>
          ))}
        </ol>
      ) : (
        <p>Il n'y a pas encore de concerts à venir</p>
      )
    }
  </section>
</Layout>

<style>
  .concerts {
    max-width: 1300px;
  }

  .concerts__main-title {
    margin-bottom: 3rem;
    text-align: center;
  }

  .concerts__sub-title {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-block: 2rem;
    text-align: center;
    font-size: 1rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: rgba(0, 0, 0, 0.6);
  }
  .concerts__sub-title::before {
    content: '';
    width: 0.5em;
    height: 0.5em;
    margin-right: 0.75em;
    border-radius: 50%;
    background-color: var(--c-orange);
  }

  .concerts__list {
    padding-left: 0;
    list-style: none;

    li {
      display: flex;
      gap: 3rem;
      align-items: flex-start;
      margin-top: 2rem;
      padding: 3rem;
      background-color: white;
      border-radius: 5rem;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }

    .infos {
      flex: 1;
      padding: 1.5rem;
      border-radius: 2.5rem;
      background-color: var(--c-beige-light);
      border: 1px solid var(--c-beige);

      & > div + div {
        margin-top: 1rem;
      }

      strong {
        display: block;
        color: var(--c-rouge);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .date {
        margin: 0;
      }

      .place {
        white-space: pre-line;

        p:first-of-type {
          margin-top: 0;
        }
      }
    }

    .content {
      flex: 3;

      .title {
        font-size: 2rem;
        color: var(--c-rouge);
      }
    }
  }

  .concerts__list--old {
    opacity: 0.75;
  }
</style>
