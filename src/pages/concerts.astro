---
import Layout from '../layouts/Layout.astro';
import { contentfulClient } from '../lib/contentful';
import type { Document } from '@contentful/rich-text-types';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';
import type { ContentfulAssetField } from '../types/contentful';

const entries = await contentfulClient.getEntries({
  content_type: 'concert',
});

const allConcerts = entries.items.map((entry) => entry.fields);

const now = new Date();
const upcomingConcerts = allConcerts
  .filter((concert) => new Date(concert.date as string) >= now)
  .sort((a, b) => new Date(a.date as string).getTime() - new Date(b.date as string).getTime());

const frenchMonths = [
  'janvier',
  'février',
  'mars',
  'avril',
  'mai',
  'juin',
  'juillet',
  'août',
  'septembre',
  'octobre',
  'novembre',
  'décembre',
];
const frenchDays = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];

const getDateParts = (dateString: string) => {
  const date = new Date(dateString);
  return {
    dayNumber: date.getDate(),
    monthYear: `${frenchMonths[date.getMonth()]} ${date.getFullYear()}`,
    dayName: frenchDays[date.getDay()],
  };
};

const getTime = (dateString: string) => {
  const date = new Date(dateString);

  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');

  return `${hours}h${minutes}`;
};
---

<Layout title="Concerts du chœur Cassiopée, Lyon - Chorale de jeunes">
  <section class="concerts c-global-container">
    <h1 class="concerts__main-title c-global-title">Nos prochains <b>concerts</b></h1>

    {
      upcomingConcerts.length > 0 ? (
        <ol class="concerts__list">
          {upcomingConcerts.map((concert) => {
            const visuel = concert.visuel as ContentfulAssetField | undefined;
            const visuelUrl = visuel?.fields?.file?.url
              ? `https:${visuel.fields.file.url}?w=1200&q=80&fm=webp`
              : null;
            const visuelAlt =
              visuel?.fields?.title || (concert.titre as string) || 'Visuel du concert';

            const dateParts = getDateParts(concert.date as string);

            return (
              <li class="concert">
                <div class="concert__infos c-global-text-container">
                  <div class="concert__date">
                    <span class="concert__date-day-name">{dateParts.dayName}</span>
                    <span class="concert__date-day-number">{dateParts.dayNumber}</span>
                    <span class="concert__date-month-year">{dateParts.monthYear}</span>
                  </div>
                  <div class="concert__hour">
                    <strong class="concert__label">Heure</strong>
                    <span class="concert__hour-value">{getTime(concert.date as string)}</span>
                  </div>
                  <div class="concert__place c-global-text-container">
                    <strong class="concert__label">Lieu</strong>
                    <Fragment set:html={documentToHtmlString(concert.lieu as Document)} />
                  </div>
                  {concert.lien && (
                    <a
                      class="concert__link"
                      href={concert.lien as string}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      <span>Lien de l'événement</span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                        <polyline points="15 3 21 3 21 9" />
                        <line x1="10" y1="14" x2="21" y2="3" />
                      </svg>
                    </a>
                  )}
                </div>
                <div class="concert__content">
                  <h2 class="concert__title c-global-title">{concert.titre}</h2>
                  {concert.texte && (
                    <div class="concert__text c-global-text-container">
                      <Fragment set:html={documentToHtmlString(concert.texte as Document)} />
                    </div>
                  )}
                  {visuelUrl && <img class="concert__visuel" src={visuelUrl} alt={visuelAlt} />}
                </div>
              </li>
            );
          })}
        </ol>
      ) : (
        <p>Il n'y a pas encore de concerts à venir</p>
      )
    }
  </section>
</Layout>

<style>
  .concerts__main-title {
    margin-bottom: 4rem;
    text-align: center;
  }

  .concerts__main-title b {
    color: var(--c-rouge);
  }

  .concerts__list {
    margin: 0;
    padding-left: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .concerts__list--old {
    opacity: 0.75;
  }

  .concert {
    display: flex;
    background: var(--c-beige-light);
    border-radius: 1rem;
    box-shadow: 0 2px 12px rgb(0 0 0 / 0.06);
    overflow: hidden;
  }

  .concert__infos {
    flex: 0 0 18rem;
    padding: 2.5rem 2rem;
    border-left: 4px solid var(--c-rouge);
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .concert__date {
    line-height: 1.1;
  }

  .concert__date-day-name {
    display: block;
    font-size: 0.875rem;
    color: #777;
    text-transform: capitalize;
  }

  .concert__date-day-number {
    display: block;
    margin-bottom: 0.3em;
    font-family: 'Cormorant Garamond', serif;
    font-size: 3.5rem;
    color: var(--c-rouge);
    font-weight: 600;
    line-height: 0.6;
  }

  .concert__date-month-year {
    display: block;
    font-size: 1rem;
    color: #555;
    margin-top: 0.25rem;
  }

  .concert__label {
    display: block;
    color: var(--c-rouge);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.15rem;
  }

  .concert__hour-value {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .concert__place {
    white-space: pre-line;
  }

  .concert__place :global(p:first-of-type) {
    margin-top: 0;
  }

  .concert__link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--c-rouge);
    font-weight: 600;
  }

  .concert__link:hover {
    text-decoration: none;
  }

  .concert__link svg {
    display: block;
    height: 1rem;
    flex-shrink: 0;
  }

  .concert__content {
    flex: 1;
    padding: 2.5rem 2.5rem 2.5rem 0;
  }

  .concert__title {
    font-size: 2rem;
    color: var(--c-rouge);
    margin-top: 0;
  }

  .concert__visuel {
    display: block;
    width: 100%;
    margin-top: 1.5rem;
    border-radius: 0.75rem;
  }

  @media (max-width: 980px) {
    .concerts__list {
      gap: 2rem;
    }

    .concert {
      flex-direction: column;
    }

    .concert__infos {
      flex: none;
      border-left: none;
      border-top: 4px solid var(--c-rouge);
      padding: 1.5rem;
      order: 2;
    }

    .concert__date-day-number {
      font-size: 2.5rem;
    }

    .concert__content {
      padding: 1.5rem;
    }

    .concert__title {
      font-size: 1.5rem;
    }
  }
</style>
