---
import Layout from '../layouts/Layout.astro';
import { contentfulClient } from '../lib/contentful';
import type { Document } from '@contentful/rich-text-types';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';
import type { ContentfulAssetField } from '../types/contentful';

const entries = await contentfulClient.getEntries({
  content_type: 'concert',
});

const allConcerts = entries.items.map((entry) => entry.fields);

const now = new Date();
const upcomingConcerts = allConcerts
  .filter((concert) => new Date(concert.date as string) >= now)
  .sort((a, b) => new Date(a.date as string).getTime() - new Date(b.date as string).getTime());

const getDate = (dateString: string) => {
  const date = new Date(dateString);
  const frenchMonths = [
    'janvier',
    'février',
    'mars',
    'avril',
    'mai',
    'juin',
    'juillet',
    'août',
    'septembre',
    'octobre',
    'novembre',
    'décembre',
  ];
  const frenchDays = ['dim.', 'lun.', 'mar.', 'mer.', 'jeu.', 'ven.', 'sam.'];

  const dayOfWeek = frenchDays[date.getDay()];
  const day = date.getDate();
  const month = frenchMonths[date.getMonth()];
  const year = date.getFullYear();

  return `${dayOfWeek} ${day} ${month} ${year}`;
};

const getTime = (dateString: string) => {
  const date = new Date(dateString);

  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');

  return `${hours}h${minutes}`;
};
---

<Layout title="Concerts du chœur Cassiopée, Lyon - Chorale de jeunes">
  <section class="concerts c-global-container">
    <h1 class="concerts__main-title c-global-title">Nos prochains <b>concerts</b></h1>

    {
      upcomingConcerts.length > 0 ? (
        <ol class="concerts__list">
          {upcomingConcerts.map((concert) => {
            const visuel = concert.visuel as ContentfulAssetField | undefined;
            const visuelUrl = visuel?.fields?.file?.url
              ? `https:${visuel.fields.file.url}?w=1200&q=80&fm=webp`
              : null;
            const visuelAlt =
              visuel?.fields?.title || (concert.titre as string) || 'Visuel du concert';

            return (
              <li>
                <div class="infos c-global-text-container">
                  <div class="date">
                    <strong>Date</strong>
                    <span>{getDate(concert.date as string)}</span>
                  </div>
                  <div class="hour">
                    <strong>Heure</strong>
                    <span>{getTime(concert.date as string)}</span>
                  </div>
                  <div class="place c-global-text-container">
                    <strong>Lieu</strong>
                    <Fragment set:html={documentToHtmlString(concert.lieu as Document)} />
                  </div>
                </div>
                <div class="content">
                  <h2 class="title c-global-title">{concert.titre}</h2>
                  {concert.texte && (
                    <div class="text c-global-text-container">
                      <Fragment set:html={documentToHtmlString(concert.texte as Document)} />
                    </div>
                  )}
                  {visuelUrl && <img class="visuel" src={visuelUrl} alt={visuelAlt} />}
                </div>
              </li>
            );
          })}
        </ol>
      ) : (
        <p>Il n'y a pas encore de concerts à venir</p>
      )
    }
  </section>
</Layout>

<style>
  .concerts {
    max-width: 1300px;
  }

  .concerts__main-title {
    margin-bottom: 4rem;
    text-align: center;

    b {
      color: var(--c-rouge);
    }
  }

  .concerts__list {
    padding-left: 0;
    list-style: none;

    li {
      display: flex;
      gap: 3rem;
      align-items: flex-start;
    }

    li + li {
      margin-top: 4rem;
      padding-top: 4rem;
      border-top: 2px dotted var(--c-taupe);
    }

    .infos {
      flex: 1;

      & > div + div {
        margin-top: 1rem;
      }

      strong {
        display: block;
        color: var(--c-rouge);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .date {
        margin: 0;
      }

      .place {
        white-space: pre-line;

        p:first-of-type {
          margin-top: 0;
        }
      }
    }

    .content {
      flex: 3;

      .title {
        font-size: 2rem;
        color: var(--c-rouge);
      }

      .visuel {
        display: block;
        width: 100%;
        margin-top: 2rem;
        border-radius: 1rem;
      }
    }
  }

  .concerts__list--old {
    opacity: 0.75;
  }

  @media (max-width: 980px) {
    .concerts__list {
      li {
        flex-direction: column;
        gap: 2rem;
      }

      .content {
        display: flex;
        flex-direction: column;

        .title {
          font-size: 1.5rem;
        }
      }

      .infos {
        order: 2;
      }
    }
  }
</style>
